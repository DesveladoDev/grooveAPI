rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Función para verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Función para verificar si el usuario es el propietario del documento
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Función para verificar si el usuario es administrador
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Función para verificar si el usuario es anfitrión
    function isHost() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'host';
    }
    
    // Función para validar datos de usuario
    function isValidUserData() {
      return request.resource.data.keys().hasAll(['email', 'name', 'role', 'createdAt']) &&
             request.resource.data.email is string &&
             request.resource.data.name is string &&
             request.resource.data.role is string &&
             request.resource.data.createdAt is timestamp;
    }
    
    // Función para validar datos de listing
    function isValidListingData() {
      return request.resource.data.keys().hasAll(['title', 'description', 'price', 'hostId', 'createdAt']) &&
             request.resource.data.title is string &&
             request.resource.data.description is string &&
             request.resource.data.price is number &&
             request.resource.data.hostId is string &&
             request.resource.data.createdAt is timestamp;
    }
    
    // Reglas para usuarios
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       isOwner(userId) && 
                       isValidUserData();
      allow update: if isAuthenticated() && 
                       (isOwner(userId) || isAdmin()) &&
                       isValidUserData();
      allow delete: if isAdmin();
      
      // Subcolección de configuraciones privadas del usuario
      match /private/{document} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
      
      // Subcolección de estadísticas del usuario
      match /stats/{document} {
        allow read: if isAuthenticated();
        allow write: if isOwner(userId) || isAdmin();
      }
    }
    
    // Reglas para anfitriones
    match /hosts/{hostId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       isOwner(hostId) &&
                       isHost();
      allow update: if isAuthenticated() && 
                       (isOwner(hostId) || isAdmin());
      allow delete: if isAdmin();
      
      // Subcolección de datos financieros del anfitrión
      match /financial/{document} {
        allow read, write: if isOwner(hostId) || isAdmin();
      }
    }
    
    // Reglas para listings
    match /listings/{listingId} {
      allow read: if true; // Público para explorar
      allow create: if isAuthenticated() && 
                       isHost() &&
                       isValidListingData() &&
                       request.resource.data.hostId == request.auth.uid;
      allow update: if isAuthenticated() && 
                       (isOwner(resource.data.hostId) || isAdmin()) &&
                       isValidListingData();
      allow delete: if isAuthenticated() && 
                       (isOwner(resource.data.hostId) || isAdmin());
      
      // Subcolección de disponibilidad
      match /availability/{document} {
        allow read: if true;
        allow write: if isAuthenticated() && 
                        (isOwner(get(/databases/$(database)/documents/listings/$(listingId)).data.hostId) || isAdmin());
      }
      
      // Subcolección de estadísticas del listing
      match /stats/{document} {
        allow read: if isAuthenticated();
        allow write: if isOwner(get(/databases/$(database)/documents/listings/$(listingId)).data.hostId) || isAdmin();
      }
    }
    
    // Reglas para reservas
    match /bookings/{bookingId} {
      allow read: if isAuthenticated() && 
                     (isOwner(resource.data.guestId) || 
                      isOwner(resource.data.hostId) || 
                      isAdmin());
      allow create: if isAuthenticated() && 
                       request.resource.data.guestId == request.auth.uid &&
                       request.resource.data.keys().hasAll(['guestId', 'hostId', 'listingId', 'checkIn', 'checkOut', 'totalPrice', 'status', 'createdAt']);
      allow update: if isAuthenticated() && 
                       (isOwner(resource.data.guestId) || 
                        isOwner(resource.data.hostId) || 
                        isAdmin());
      allow delete: if isAdmin();
      
      // Subcolección de pagos
      match /payments/{document} {
        allow read: if isAuthenticated() && 
                       (isOwner(get(/databases/$(database)/documents/bookings/$(bookingId)).data.guestId) || 
                        isOwner(get(/databases/$(database)/documents/bookings/$(bookingId)).data.hostId) || 
                        isAdmin());
        allow write: if isAdmin(); // Solo el sistema puede escribir pagos
      }
    }
    
    // Reglas para chats
    match /chats/{chatId} {
      allow read: if isAuthenticated() && 
                     (request.auth.uid in resource.data.participants);
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.participants &&
                       request.resource.data.participants.size() == 2;
      allow update: if isAuthenticated() && 
                       (request.auth.uid in resource.data.participants);
      allow delete: if isAdmin();
      
      // Subcolección de mensajes
      match /messages/{messageId} {
        allow read: if isAuthenticated() && 
                       (request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
        allow create: if isAuthenticated() && 
                         request.resource.data.senderId == request.auth.uid &&
                         request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        allow update: if isAuthenticated() && 
                         isOwner(resource.data.senderId);
        allow delete: if isAuthenticated() && 
                         (isOwner(resource.data.senderId) || isAdmin());
      }
    }
    
    // Reglas para reseñas
    match /reviews/{reviewId} {
      allow read: if true; // Las reseñas son públicas
      allow create: if isAuthenticated() && 
                       request.resource.data.reviewerId == request.auth.uid &&
                       request.resource.data.keys().hasAll(['reviewerId', 'reviewedId', 'rating', 'createdAt']);
      allow update: if isAuthenticated() && 
                       (isOwner(resource.data.reviewerId) || isAdmin());
      allow delete: if isAuthenticated() && 
                       (isOwner(resource.data.reviewerId) || isAdmin());
    }
    
    // Reglas para notificaciones
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && 
                     isOwner(resource.data.userId);
      allow create: if isAdmin(); // Solo el sistema puede crear notificaciones
      allow update: if isAuthenticated() && 
                       isOwner(resource.data.userId); // Solo para marcar como leída
      allow delete: if isAuthenticated() && 
                       (isOwner(resource.data.userId) || isAdmin());
    }
    
    // Reglas para reportes administrativos
    match /admin/{document} {
      allow read, write: if isAdmin();
      
      // Subcolección de reportes
      match /reports/{reportId} {
        allow read, write: if isAdmin();
      }
      
      // Subcolección de configuraciones
      match /settings/{settingId} {
        allow read, write: if isAdmin();
      }
    }
    
    // Reglas para configuraciones globales de la app
    match /app_settings/{document} {
      allow read: if true; // Configuraciones públicas
      allow write: if isAdmin();
    }
    
    // Reglas para reportes de usuarios (denuncias)
    match /reports/{reportId} {
      allow read: if isAuthenticated() && 
                     (isOwner(resource.data.reporterId) || isAdmin());
      allow create: if isAuthenticated() && 
                       request.resource.data.reporterId == request.auth.uid;
      allow update: if isAdmin(); // Solo admins pueden actualizar el estado
      allow delete: if isAdmin();
    }
    
    // Reglas para tokens FCM
    match /fcm_tokens/{userId} {
      allow read, write: if isAuthenticated() && isOwner(userId);
    }
    
    // Reglas para estadísticas globales
    match /global_stats/{document} {
      allow read: if isAdmin();
      allow write: if false; // Solo Cloud Functions pueden escribir
    }
    
    // Reglas para logs del sistema
    match /system_logs/{document} {
      allow read: if isAdmin();
      allow write: if false; // Solo Cloud Functions pueden escribir
    }
    
    // Reglas para webhooks de Stripe
    match /stripe_events/{document} {
      allow read: if isAdmin();
      allow write: if false; // Solo Cloud Functions pueden escribir
    }
    
    // Reglas por defecto - denegar todo lo demás
    match /{document=**} {
      allow read, write: if false;
    }
  }
}