name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.24.5'
  JAVA_VERSION: '17'
  NODE_VERSION: '18'

jobs:
  # Job 1: AnÃ¡lisis estÃ¡tico y linting
  analyze:
    name: ğŸ” Code Analysis & Linting
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ” Verify formatting
        run: dart format --output=none --set-exit-if-changed .

      - name: ğŸ“Š Analyze project source
        run: flutter analyze --fatal-infos

      - name: ğŸ§ª Check for unused dependencies
        run: flutter pub deps

  # Job 2: Tests unitarios y de widgets
  test:
    name: ğŸ§ª Unit & Widget Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: analyze
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ—ï¸ Generate mocks
        run: dart run build_runner build --delete-conflicting-outputs

      - name: ğŸ§ª Run unit tests
        run: flutter test test/unit/ --coverage --reporter=github

      - name: ğŸ¨ Run widget tests
        run: flutter test test/widget/ --coverage --reporter=github

      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          file: coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # Job 3: Tests de integraciÃ³n con Firebase Emulators
  integration-test:
    name: ğŸ”¥ Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: analyze
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”¥ Install Firebase CLI
        run: npm install -g firebase-tools

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ—ï¸ Generate mocks
        run: dart run build_runner build --delete-conflicting-outputs

      - name: ğŸ”¥ Start Firebase Emulators
        run: |
          firebase emulators:start --only auth,firestore,storage --project demo-project &
          sleep 30

      - name: ğŸ§ª Run integration tests
        run: flutter test test/integration/ --coverage --reporter=github

      - name: ğŸ›‘ Stop Firebase Emulators
        run: firebase emulators:stop || true

  # Job 4: Build para Android
  build-android:
    name: ğŸ¤– Build Android
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [test, integration-test]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ—ï¸ Build APK (Debug)
        run: flutter build apk --debug

      - name: ğŸ—ï¸ Build APK (Release)
        run: flutter build apk --release

      - name: ğŸ“¤ Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: |
            build/app/outputs/flutter-apk/app-debug.apk
            build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

  # Job 5: Build para iOS (solo en macOS)
  build-ios:
    name: ğŸ Build iOS
    runs-on: macos-latest
    timeout-minutes: 45
    needs: [test, integration-test]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ“± Setup iOS dependencies
        run: |
          cd ios
          pod install

      - name: ğŸ—ï¸ Build iOS (Debug)
        run: flutter build ios --debug --no-codesign

      - name: ğŸ—ï¸ Build iOS (Release)
        run: flutter build ios --release --no-codesign

  # Job 6: Build para Web
  build-web:
    name: ğŸŒ Build Web
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [test, integration-test]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸŒ Build for web
        run: flutter build web --release

      - name: ğŸ“¤ Upload web build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web/
          retention-days: 30

  # Job 7: AnÃ¡lisis de seguridad
  security:
    name: ğŸ”’ Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: analyze
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ” Run security audit
        run: flutter pub audit

      - name: ğŸ”’ Check for hardcoded secrets
        run: |
          # Buscar posibles secretos hardcodeados
          if grep -r -i "api[_-]key\|secret\|password\|token" lib/ --include="*.dart" | grep -v "// TODO\|// FIXME"; then
            echo "âš ï¸ Possible hardcoded secrets found!"
            exit 1
          else
            echo "âœ… No hardcoded secrets detected"
          fi

  # Job 8: NotificaciÃ³n de resultados
  notify:
    name: ğŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [analyze, test, integration-test, build-android, build-ios, build-web, security]
    if: always()
    
    steps:
      - name: ğŸ“Š Check job results
        run: |
          echo "ğŸ” Analyze: ${{ needs.analyze.result }}"
          echo "ğŸ§ª Test: ${{ needs.test.result }}"
          echo "ğŸ”¥ Integration Test: ${{ needs.integration-test.result }}"
          echo "ğŸ¤– Build Android: ${{ needs.build-android.result }}"
          echo "ğŸ Build iOS: ${{ needs.build-ios.result }}"
          echo "ğŸŒ Build Web: ${{ needs.build-web.result }}"
          echo "ğŸ”’ Security: ${{ needs.security.result }}"
          
          if [[ "${{ needs.analyze.result }}" == "failure" || "${{ needs.test.result }}" == "failure" || "${{ needs.integration-test.result }}" == "failure" || "${{ needs.security.result }}" == "failure" ]]; then
            echo "âŒ Pipeline failed!"
            exit 1
          else
            echo "âœ… Pipeline completed successfully!"
          fi