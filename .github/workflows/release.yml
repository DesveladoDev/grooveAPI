name: ðŸš€ Release Pipeline

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

env:
  FLUTTER_VERSION: '3.24.5'
  JAVA_VERSION: '17'
  NODE_VERSION: '18'

jobs:
  # Job 1: Validar tag y preparar release
  prepare-release:
    name: ðŸ“‹ Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v5

      - name: ðŸ·ï¸ Extract version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
          echo "tag=${VERSION}" >> $GITHUB_OUTPUT
          echo "Release version: ${VERSION}"

      - name: ðŸ“ Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected format: x.y.z (e.g., 1.0.0)"
            exit 1
          fi
          echo "âœ… Version format is valid: $VERSION"

  # Job 2: Tests completos antes del release
  test-release:
    name: ðŸ§ª Release Tests
    runs-on: ubuntu-latest
    needs: prepare-release
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v5

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ”¥ Install Firebase CLI
        run: npm install -g firebase-tools

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ—ï¸ Generate mocks
        run: dart run build_runner build --delete-conflicting-outputs

      - name: ðŸ” Analyze code
        run: flutter analyze --fatal-infos

      - name: ðŸ§ª Run all tests
        run: |
          # Start Firebase Emulators
          firebase emulators:start --only auth,firestore,storage --project demo-project &
          sleep 30
          
          # Run tests
          flutter test --coverage --reporter=github
          
          # Stop emulators
          firebase emulators:stop || true

  # Job 3: Build Android Release
  build-android-release:
    name: ðŸ¤– Build Android Release
    runs-on: ubuntu-latest
    needs: [prepare-release, test-release]
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v5

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ”§ Update version in pubspec.yaml
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          sed -i "s/^version: .*/version: ${VERSION}+${GITHUB_RUN_NUMBER}/" pubspec.yaml
          echo "Updated version to: ${VERSION}+${GITHUB_RUN_NUMBER}"

      - name: ðŸ—ï¸ Build APK Release
        run: flutter build apk --release

      - name: ðŸ—ï¸ Build App Bundle
        run: flutter build appbundle --release

      - name: ðŸ“¤ Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release-${{ needs.prepare-release.outputs.version }}
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
          retention-days: 90

  # Job 4: Build iOS Release
  build-ios-release:
    name: ðŸŽ Build iOS Release
    runs-on: macos-latest
    needs: [prepare-release, test-release]
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v5

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ”§ Update version in pubspec.yaml
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          sed -i '' "s/^version: .*/version: ${VERSION}+${GITHUB_RUN_NUMBER}/" pubspec.yaml
          echo "Updated version to: ${VERSION}+${GITHUB_RUN_NUMBER}"

      - name: ðŸ“± Setup iOS dependencies
        run: |
          cd ios
          pod install

      - name: ðŸ—ï¸ Build iOS Release
        run: flutter build ios --release --no-codesign

      - name: ðŸ“¦ Create iOS Archive
        run: |
          cd ios
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -destination generic/platform=iOS \
            -archivePath build/Runner.xcarchive \
            archive

      - name: ðŸ“¤ Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-release-${{ needs.prepare-release.outputs.version }}
          path: ios/build/Runner.xcarchive
          retention-days: 90

  # Job 5: Build Web Release
  build-web-release:
    name: ðŸŒ Build Web Release
    runs-on: ubuntu-latest
    needs: [prepare-release, test-release]
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v5

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ”§ Update version in pubspec.yaml
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          sed -i "s/^version: .*/version: ${VERSION}+${GITHUB_RUN_NUMBER}/" pubspec.yaml
          echo "Updated version to: ${VERSION}+${GITHUB_RUN_NUMBER}"

      - name: ðŸŒ Build Web Release
        run: flutter build web --release --web-renderer canvaskit

      - name: ðŸ“¦ Create Web Archive
        run: |
          cd build/web
          tar -czf ../web-release-${{ needs.prepare-release.outputs.version }}.tar.gz .

      - name: ðŸ“¤ Upload Web artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-release-${{ needs.prepare-release.outputs.version }}
          path: build/web-release-${{ needs.prepare-release.outputs.version }}.tar.gz
          retention-days: 90

  # Job 6: Crear GitHub Release
  create-release:
    name: ðŸ“ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare-release, build-android-release, build-ios-release, build-web-release]
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: ðŸ“¥ Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-release-${{ needs.prepare-release.outputs.version }}
          path: ./artifacts/android/

      - name: ðŸ“¥ Download iOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: ios-release-${{ needs.prepare-release.outputs.version }}
          path: ./artifacts/ios/

      - name: ðŸ“¥ Download Web artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-release-${{ needs.prepare-release.outputs.version }}
          path: ./artifacts/web/

      - name: ðŸ“ Generate changelog
        id: changelog
        run: |
          # Generar changelog desde el Ãºltimo tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [[ -n "$LAST_TAG" ]]; then
            CHANGELOG=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s" --no-merges)
          else
            CHANGELOG="- Initial release"
          fi
          
          # Guardar changelog en archivo
          cat > RELEASE_NOTES.md << EOF
          ## ðŸš€ Release ${{ needs.prepare-release.outputs.tag }}
          
          ### ðŸ“± Downloads
          - **Android APK**: app-release.apk
          - **Android Bundle**: app-release.aab  
          - **iOS Archive**: Runner.xcarchive
          - **Web Build**: web-release-${{ needs.prepare-release.outputs.version }}.tar.gz
          
          ### ðŸ“‹ Changes
          ${CHANGELOG}
          
          ### ðŸ”§ Technical Details
          - Flutter Version: ${{ env.FLUTTER_VERSION }}
          - Build Number: ${GITHUB_RUN_NUMBER}
          - Commit: ${GITHUB_SHA:0:7}
          EOF

      - name: ðŸ·ï¸ Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag }}
          name: Release ${{ needs.prepare-release.outputs.tag }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            artifacts/android/app-release.apk
            artifacts/android/app-release.aab
            artifacts/web/web-release-${{ needs.prepare-release.outputs.version }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 7: Deploy a Firebase Hosting (opcional)
  deploy-web:
    name: ðŸŒ Deploy to Firebase Hosting
    runs-on: ubuntu-latest
    needs: [prepare-release, build-web-release]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v5

      - name: ðŸ“¥ Download Web artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-release-${{ needs.prepare-release.outputs.version }}
          path: ./

      - name: ðŸ“¦ Extract Web build
        run: |
          tar -xzf web-release-${{ needs.prepare-release.outputs.version }}.tar.gz -C build/web/

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ”¥ Install Firebase CLI
        run: npm install -g firebase-tools

      - name: ðŸš€ Deploy to Firebase Hosting
        run: firebase deploy --only hosting --project ${{ secrets.FIREBASE_PROJECT_ID }}
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

  # Job 8: NotificaciÃ³n final
  notify-release:
    name: ðŸ“¢ Notify Release
    runs-on: ubuntu-latest
    needs: [prepare-release, create-release, deploy-web]
    if: always()
    
    steps:
      - name: ðŸ“Š Release Summary
        run: |
          echo "ðŸŽ‰ Release ${{ needs.prepare-release.outputs.tag }} completed!"
          echo "ðŸ“¦ Artifacts created for Android, iOS, and Web"
          echo "ðŸ”— GitHub Release: https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare-release.outputs.tag }}"
          
          if [[ "${{ needs.deploy-web.result }}" == "success" ]]; then
            echo "ðŸŒ Web app deployed to Firebase Hosting"
          fi